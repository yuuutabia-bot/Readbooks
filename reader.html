<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Book Reader</title>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #111;
  color: white;
  text-align: center;
}

header {
  background: #202124;
  padding: 10px;
  position: sticky;
  top: 0;
  z-index: 100;
}

#pdf-container {
  display: flex;
  flex-direction: column;
  align-items: center;
}

canvas {
  margin: 15px 0;
  background: white;
}

#loader {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  border: 6px solid #333;
  border-top: 6px solid #4f46e5;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  display: none;
}

@keyframes spin {
  0% { transform: translate(-50%, -50%) rotate(0deg); }
  100% { transform: translate(-50%, -50%) rotate(360deg); }
}

/* Popup Ad */
#ad-popup {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #222;
  padding: 20px;
  border-radius: 10px;
  display: none;
  z-index: 999;
  max-width: 300px;
}

#ad-popup button {
  margin-top: 10px;
  padding: 5px 10px;
}
</style>
</head>

<body>

<header>
  ðŸ“– Scroll Mode Reader
</header>

<div id="loader"></div>
<div id="pdf-container"></div>

<!-- Popup Ad -->
<div id="ad-popup">
  ðŸ”¥ Iklan Spesial! <br><br>
  Pasang Google AdSense di sini ðŸ’°
  <br>
  <button onclick="closeAd()">Tutup</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

<script>
const urlParams = new URLSearchParams(window.location.search);
const book = urlParams.get("book");
const url = "books/" + book;

let pdfDoc = null;
let scale = 1.1;
let pagesViewed = 0;

const container = document.getElementById("pdf-container");
const loader = document.getElementById("loader");
const popup = document.getElementById("ad-popup");

function showLoader() { loader.style.display = "block"; }
function hideLoader() { loader.style.display = "none"; }

showLoader();

pdfjsLib.getDocument(url).promise.then(pdfDoc_ => {
  pdfDoc = pdfDoc_;
  renderAllPages();
});

function renderAllPages() {
  for (let num = 1; num <= pdfDoc.numPages; num++) {
    pdfDoc.getPage(num).then(page => {

      const viewport = page.getViewport({ scale });
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      canvas.height = viewport.height;
      canvas.width = viewport.width;

      container.appendChild(canvas);

      page.render({
        canvasContext: ctx,
        viewport: viewport
      }).promise.then(() => {
        hideLoader();
      });
    });
  }
}

/* Track Scroll for Ads + Save Page */
window.addEventListener("scroll", () => {

  const canvases = document.querySelectorAll("canvas");

  canvases.forEach((canvas, index) => {
    const rect = canvas.getBoundingClientRect();

    if (rect.top >= 0 && rect.top < window.innerHeight / 2) {

      const currentPage = index + 1;

      localStorage.setItem("lastPage_" + book, currentPage);

      if (currentPage % 5 === 0 && pagesViewed !== currentPage) {
        pagesViewed = currentPage;
        showAd();
      }
    }
  });

});

/* Restore Scroll Position */
window.onload = function() {
  const savedPage = localStorage.getItem("lastPage_" + book);
  if (savedPage) {
    setTimeout(() => {
      const targetCanvas = document.querySelectorAll("canvas")[savedPage - 1];
      if (targetCanvas) {
        targetCanvas.scrollIntoView();
      }
    }, 1000);
  }
};

function showAd() {
  popup.style.display = "block";
}

function closeAd() {
  popup.style.display = "none";
}
</script>

</body>
</html>
