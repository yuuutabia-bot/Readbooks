<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Yuuutabia Reader</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>

<style>
body {
  margin: 0;
  background: #f1f5f9;
  font-family: Arial, sans-serif;
  overflow-x: hidden;
}

/* HEADER */
header {
  position: fixed;
  top: 0;
  width: 100%;
  background: #111827;
  color: white;
  padding: 10px;
  text-align: center;
  z-index: 1000;
  transition: top 0.3s;
}

#progress-bar {
  height: 3px;
  background: #6366f1;
  width: 0%;
  transition: width 0.3s;
}

.controls {
  margin-top: 6px;
}

button {
  padding: 6px 10px;
  margin: 3px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

#page-slider {
  width: 80%;
  margin-top: 5px;
}

/* CONTAINER */
#pdf-container {
  margin-top: 150px;
  text-align: center;
}

canvas {
  max-width: 100%;
  margin-bottom: 15px;
}

.slide-in {
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from { transform: translateX(40px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

/* SCROLL MODE CLEAN */
.scroll-mode header {
  display: none;
}

.scroll-mode #pdf-container {
  margin-top: 20px;
}
</style>
</head>

<body>

<header id="header">
  ðŸ“– Reader
  <div id="progress-bar"></div>

  <div class="controls">
    <button onclick="setMode('page')">Page Mode</button>
    <button onclick="setMode('scroll')">Scroll Mode</button>
    <br>
    <div id="page-controls">
      <button onclick="prevPage()">â¬…</button>
      <button onclick="nextPage()">âž¡</button>
      <br>
      <input type="range" id="page-slider" min="1" value="1">
      <span id="page-num"></span>
    </div>
  </div>
</header>

<div id="pdf-container"></div>

<script>

let urlParams = new URLSearchParams(window.location.search);
let book = urlParams.get("book");

let pdfDoc = null;
let currentPage = 1;
let mode = localStorage.getItem("readerMode") || "page";
let savedPage = localStorage.getItem(book + "-lastPage");

pdfjsLib.getDocument(book).promise.then(function(pdf){
  pdfDoc = pdf;

  if(savedPage){
    currentPage = parseInt(savedPage);
  }

  document.getElementById("page-slider").max = pdf.numPages;
  applyMode();
});

/* ================= MODE ================= */

function setMode(selected){
  localStorage.setItem("readerMode", selected);
  location.reload();
}

function applyMode(){
  if(mode === "scroll"){
    document.body.classList.add("scroll-mode");
    document.getElementById("page-controls").style.display = "none";
    renderScroll();
  } else {
    document.body.classList.remove("scroll-mode");
    document.getElementById("page-controls").style.display = "block";
    renderPage(currentPage);
  }
}

/* ================= PAGE MODE ================= */

function renderPage(num){
  document.getElementById("pdf-container").innerHTML = "";

  pdfDoc.getPage(num).then(function(page){
    let viewport = page.getViewport({scale: 1.3});
    let canvas = document.createElement("canvas");
    let ctx = canvas.getContext("2d");

    canvas.height = viewport.height;
    canvas.width = viewport.width;
    canvas.classList.add("slide-in");

    document.getElementById("pdf-container").appendChild(canvas);

    page.render({
      canvasContext: ctx,
      viewport: viewport
    });

    document.getElementById("page-num").textContent =
      "Page " + num + " / " + pdfDoc.numPages;

    document.getElementById("page-slider").value = num;

    updateProgress();
    savePage();
  });
}

function nextPage(){
  if(currentPage >= pdfDoc.numPages) return;
  currentPage++;
  renderPage(currentPage);
}

function prevPage(){
  if(currentPage <= 1) return;
  currentPage--;
  renderPage(currentPage);
}

document.getElementById("page-slider").addEventListener("input", function(){
  currentPage = parseInt(this.value);
  renderPage(currentPage);
});

/* ================= SCROLL MODE ================= */

function renderScroll(){
  document.getElementById("pdf-container").innerHTML = "";

  for(let num = 1; num <= pdfDoc.numPages; num++){
    pdfDoc.getPage(num).then(function(page){
      let viewport = page.getViewport({scale: 1.2});
      let canvas = document.createElement("canvas");
      let ctx = canvas.getContext("2d");

      canvas.height = viewport.height;
      canvas.width = viewport.width;

      document.getElementById("pdf-container").appendChild(canvas);

      page.render({
        canvasContext: ctx,
        viewport: viewport
      });
    });
  }
}

/* ================= SAVE ================= */

function savePage(){
  localStorage.setItem(book + "-lastPage", currentPage);
}

/* ================= PROGRESS ================= */

function updateProgress(){
  let percent = (currentPage / pdfDoc.numPages) * 100;
  document.getElementById("progress-bar").style.width = percent + "%";
}

/* ================= SWIPE (PAGE MODE ONLY) ================= */

let touchStartX = 0;

document.addEventListener("touchstart", function(e){
  if(mode !== "page") return;
  touchStartX = e.changedTouches[0].screenX;
});

document.addEventListener("touchend", function(e){
  if(mode !== "page") return;

  let touchEndX = e.changedTouches[0].screenX;

  if(touchEndX < touchStartX - 50) nextPage();
  if(touchEndX > touchStartX + 50) prevPage();
});

/* ================= AUTO HIDE HEADER (PAGE MODE) ================= */

let lastScroll = 0;
window.addEventListener("scroll", function(){
  if(mode !== "page") return;

  let currentScroll = window.pageYOffset;

  if(currentScroll > lastScroll){
    document.getElementById("header").style.top = "-170px";
  } else {
    document.getElementById("header").style.top = "0";
  }

  lastScroll = currentScroll;
});

</script>

</body>
</html>
